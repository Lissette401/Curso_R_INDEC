---
title: "Introducción al uso de bases de datos con R"
subtitle: "Clase 2 - Practica guiada"
date: "25/10/2019"
output:
  html_notebook:
    toc: yes
    toc_float: yes
  html_document:
    toc: yes
---

## Manejo de bases de datos - Aplicacion con EPH

Luego de abordar las principales funciones necesarias para operar sobre las bases de datos, veremos su aplicación con la base individual del 1er Trimestre de 2019 de la EPH. 


En primer lugar, cargamos la librería que usaremos para leer y escribir archivos en excel. 
```{r, message=FALSE, warning=FALSE}
library(openxlsx) 
```

<br>

### Carga de Información

La función __list.files__ nos permite observar los archivos que contiene una determinada carpeta             

```{r eval=FALSE, include=FALSE}
list.files("../Fuentes/")
```


La función __read.table__ nos permite levantar los archivos de extensión ".txt"               
La función __read.xlsx__ nos permite levantar los archivos de extensión ".xlsx"                 

<br>

### **Ejercicio 1** - Cargamos la base de datos
Levantar la base individual del primer trimestre de 2019.
```{r}
individual_t119 <-
  read.table("../Fuentes/usu_individual_t119.txt",
  sep = ";",
  dec = ",",
  header = TRUE,
  fill = TRUE )

```

<br>

### **Ejercicio 2** - Conociendo los datos

2.1. Obtener la estructura básica de nuestro dataframe.

```{r}
str(individual_t119)
```

2.2. Obtener los estadísticos principales de la distribución del ingreso de la ocupación principal:

```{r}
summary(individual_t119$P21)
```

```{r}
summary(individual_t119$P21[individual_t119$ESTADO==1])
```

2.3. Sacar la frecuencia simple de la variable ESTADO:

```{r}
table(individual_t119$ESTADO,exclude = NULL)
```

2.4. Visualizar los valores perdidos de la base completa de la manera que lo hicimos la clase pasada sería prácticamente imposible, dada la magnitud de la base. Pero podríamos usar la función __any__ para identificar si hay algún valor perdido (ya sea en la base completa o en alguna variable en particular).

```{r}
any(is.na(individual_t119))
```

```{r}
any(is.na(individual_t119$NIVEL_ED))
```


### **Ejercicio 3** - Transformaciones de la base de datos


Cargamos la librería __tidyverse__ que vamos a utilizar para trabajar la base.

```{r}
library(tidyverse)
```

3.1. Filtrar nuestra base para quedarnos solo con las observaciones de la region 43 y guardarlo en un objeto que se llame **pampeana**

```{r}
pampeana <- individual_t119 %>% 
  filter(REGION==43)
```

3.2. Renombrar la variable P21 por ingreso_OP.

```{r}
individual_t119 <- individual_t119 %>% 
  rename(ingreso_OP = P21)

```

3.3. Crear una nueva variable "ingreso_horario" que sea el ingreso por hora de la ocupación principal (P21/PP3E_TOT)

```{r}
individual_t119 <- individual_t119 %>% 
  mutate(ingreso_horario = ingreso_OP/PP3E_TOT)
```

3.4. Crear una variable "nivel_ed2" que agrupe los niveles educativos de la variable NIVEL_ED en 4:

* Sin educación, primaria incompleta, o Ns.Nr.
* Hasta secundaria incompleta
* Hasta universitaria incompleta
* Universitaria completa


```{r}
individual_t119 <- individual_t119 %>% 
  mutate(nivel_ed2 = case_when(NIVEL_ED==1|NIVEL_ED==7|NIVEL_ED==9 ~ 1,
                               NIVEL_ED==2|NIVEL_ED==3 ~ 2,
                               NIVEL_ED==4|NIVEL_ED==5 ~ 3,
                               NIVEL_ED==6~ 4))

table(individual_t119$nivel_ed2,exclude = NULL)


```


3.5. Quedarnos solo con las siguientes variables de la base de datos:

ANO4,TRIMESTRE,REGION,AGLOMERADO,ESTADO,PONDERA


```{r}
recorte <- individual_t119 %>% 
  select(ANO4,TRIMESTRE,REGION,AGLOMERADO,ESTADO,PONDERA)

```

3.6. Ordenar los datos del recorte anterior por REGION y ESTADO.

```{r}
recorte <- recorte %>% 
  arrange (REGION,ESTADO)

```


3.7. Crear una tabla llamada **poblacion_ocupados** que me de la información del total de población y el total de los ocupados.

Nota:
 - Población: Si contaramos cuantos registros tiene la base, simplemente tendríamos el numero de individuos muestral de la EPH, por ende debemos **sumar los valores de la variable PONDERA**, para contemplar a cuantas personas representa cada individuo encuestado. 
 - Ocupados: En este caso, debemos agregar un **filtro** al procedimiento anterior, ya que unicamente queremos sumar los ponderadores de aquellas personas que se encuentran ocupadas. (La lógica seria: "Suma los valores de la columna PONDERA, solo para aquellos registros donde el ESTADO == 1")    

```{r}
poblacion_ocupados <- individual_t119 %>% 
  summarise(Poblacion         = sum(PONDERA),
            Ocupados          = sum(PONDERA[ESTADO == 1]))

```


3.8. A partir de la información anterior, calcular la **tasa de empleo**, definida como:            

- Tasa de empleo:  $\frac{Ocupados}{Poblacion}$ 
      

```{r}
Empleo <- individual_t119 %>% 
  summarise(Poblacion         = sum(PONDERA),
            Ocupados          = sum(PONDERA[ESTADO == 1]),
            Tasa_Empleo    = Ocupados/Poblacion)

```


3.9. Calcular la tasa de actividad, empleo y desocupación.

- Tasa de actividad:  $\frac{PEA}{Poblacion}$ 

- Tasa de desocupacion:  $\frac{Desocupados}{PEA}$ 


```{r}

Tasas <- individual_t119 %>% 
  summarise(Poblacion         = sum(PONDERA),
            Ocupados          = sum(PONDERA[ESTADO == 1]),
            Desocupados       = sum(PONDERA[ESTADO == 2]),
            PEA               = Ocupados + Desocupados,
# También podemos llamar a las variables entre comillas, incluyendo nombres compuestos
# A su vez, podemos utilizar la variable recién creada en la definción de otra varible
            'Tasa Actividad'                  = PEA/Poblacion,
            'Tasa Empleo'                     = Ocupados/Poblacion,
            'Tasa Desocupacion'               = Desocupados/PEA)


```

3.10. Cambiar el formato de la tabla para que queden los nombres de las tasas en la primer columna y los valores en la segunda columna.


```{r}

Tasas1 <- Tasas %>% 
  select(5:7) %>% 
  gather(.,
         key = tasa,
         value= valor, 
         1:3)



```


3.11. Cargar la base "Aglomerados EPH" que se encuentra en la carpeta fuentes. Unir ambas bases a partir de la variable AGLOMERADO.

```{r}
aglomeradoseph <- read.xlsx("../Fuentes/Aglomerados EPH.xlsx")

base <- left_join(individual_t119,aglomeradoseph, by="AGLOMERADO")

```



3.11. Calcular las tasas basicas por aglomerado usando los nombres de los aglomerados.


```{r echo=TRUE}
tasas_aglo<- base %>% 
  group_by(Nom_Aglo) %>% 
  summarise(Poblacion         = sum(PONDERA),
            Ocupados          = sum(PONDERA[ESTADO == 1]),
            Desocupados       = sum(PONDERA[ESTADO == 2]),
            PEA               = Ocupados + Desocupados,
            'Tasa Actividad'                  = PEA/Poblacion,
            'Tasa Empleo'                     = Ocupados/Poblacion,
            'Tasa Desocupacion'               = Desocupados/PEA)

tasas_aglo

```


