---
title: "Módulo Gráficos"
output:
  html_document:
    df_print: paged
    toc: yes
  html_notebook:
    toc: yes
    toc_float: yes
subtitle: Práctica guiada
editor_options:
  chunk_output_type: console
---

- Cargo las librerías con las que voy a trabajar:
```{r include=FALSE}
library(eph)
library(tidyverse)
library(questionr)
library(ggthemes)
```

***

<br>
<br>

## Gráfico de barras con variables numéricas

### Supongamos que queremos comparar la media del ingreso por la ocupación principal de las y los asalariados según la condición de registro.

<br>

__1. Descargamos la base de datos con la que vamos a trabajar:__
```{r echo=TRUE}
base <- get_microdata(year = 2018, trimester = 4, type = "individual")
```

<br>

__2. Estructuramos la base para obtener la información que queremos visualizar:__
```{r echo=TRUE}
medias <- base %>% 
  filter(ESTADO == 1, CAT_OCUP == 3) %>% 
  mutate(condicion_registro = factor(PP07H,
                                     levels = c(1, 2),
                                     labels = c( "Registrado", "No registrado"))) %>% 
  group_by(condicion_registro) %>% 
  summarise(media = wtd.mean(P21))
```

<br>

__3. Graficamos__
```{r echo=TRUE}
medias %>% 
  ggplot(aes(x = condicion_registro,
             y = media,
             fill = condicion_registro)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = round(media, 1)),
            vjust = 1) +
  labs(title = "Media del ingreso de la ocupación principal de la \n población asalariada por condición de registro. Total aglomerados",
       x = "Condición de registro",
       y = "Media del ingreso de la Ocup. Principal",
       caption = "Fuente: Elaboración propia en base a la EPH-INDEC") +
  theme_clean()
  #ggsave(filename = "barras_media.png", width = 6, height = 5)
```

<br>

- _Con `labs` agregamos las etiquetas al gráfico (título, subtítulo, nombre de los ejes, notas al pie, etc.)._

    - _Con ` \n ` podemos "partir" el título tantas veces como querramos._
  
<br>

- _Con `geom_text()` agregamos las etiquetas de los valores que toma la variable en el gráfico_


<br>
<br>


***

<br>

## Gráfico de barras para variables categóricas

<br>

- Intentemos graficar cómo se distribuye la población en función del nivel educativo de las personas y el sexo:

<br>

- Al ser ambas variables cualitativas, tendremos que estructura la base en fución:

```{r}
base_graf <- base %>% 
  mutate(nivel_educativo = factor(NIVEL_ED,
                                  levels = c(7, 1:6),
                                  labels = c("Sin instrucción", "Primaria incompleta",
                                             "Primaria completa", "Secundaria incompleta",
                                             "Secundaria completa", "Superior incompleta",
                                             "Superior completa")),
         sexo               = factor(CH04,
                                     levels = c(1, 2),
                                     labels = c("Varón", "Mujer"))) %>% 
  select(nivel_educativo, sexo, PONDERA)
```

<br>
<br>

***

## Parámetro de posición (`position = ""`)

<br>

### - __position = "stack"__

* Posiciona de forma apilada cada una de las categorías, acumulando cantidades.
```{r echo=TRUE}
ggplot(data = base_graf) +
  geom_bar(aes(x = nivel_educativo,
               fill = sexo),
           position = "stack")
```

<br>
<br>

### - __position = "fill"__

* Posiciona de forma apilada cada una de las categorías, con límites de 0 a 1 (para comparación de proporciones)
```{r echo=TRUE}
ggplot(data = base_graf) +
  geom_bar(aes(x = nivel_educativo,
               fill = sexo),
           position = "fill")
```

<br>
<br>

### - __position = "dodge"__

* Posiona de forma vertical las barras en función de las categorías
```{r echo=TRUE}
ggplot(data = base_graf) +
  geom_bar(aes(x = nivel_educativo,
               fill = sexo),
           position = "dodge")
```

<br>
<br>

***

### _¿Y si invertimos el análisis?_

<br>

### __position = "stack"__

* Posiciona de forma apilada cada una de las categorías, acumulando cantidades.
```{r echo=TRUE}
ggplot(data = base_graf) +
  geom_bar(aes(x = sexo,
               fill = nivel_educativo),
           position = "stack")
```

<br>
<br>

### __position = "fill"__

* Posiciona de forma apilada cada una de las categorías, con límites de 0 a 1 (para comparación de proporciones)
```{r echo=TRUE}
ggplot(data = base_graf) +
  geom_bar(aes(x = sexo,
               fill = nivel_educativo),
           position = "fill")
```

<br>
<br>

### __position = "dodge"__

* Posiona de forma vertical las barras en función de las categorías
```{r echo=TRUE}
ggplot(data = base_graf) +
  geom_bar(aes(x = sexo,
               fill = nivel_educativo),
           position = "dodge")
```

<br> 
<br>

***

### _En el mismo gráfico podemos ir editando algo del estilo:

<br>

Con `scale_fill_viridis_d` cambiamos la paleta de colores a la escala _"viridis"_, diseñada por expertos en visualización de la información, pensada para lucir bien y poder ser leída incluso por gente con daltonismo.
```{r echo=TRUE}
base_graf2 <- base_graf %>%
  calculate_tabulates("sexo", "nivel_educativo", weights = "PONDERA") %>% 
  gather(key = nivel_educativo, value = poblacion, 2:8) %>% 
  rename(sexo = `sexo/nivel_educativo`) %>% 
  group_by(sexo) %>% 
  mutate(pob_porcentaje = poblacion / sum(poblacion)*100)


sum(base_graf2$pob_porcentaje[base_graf2$sexo=="Varón"])

ggplot(data = base_graf2) +
  geom_bar(aes(x = sexo,
               y = pob_porcentaje,
               fill = nivel_educativo),
           position = "dodge",
           stat     = "identity") +
  geom_text(aes(x = sexo, 
                y = pob_porcentaje,
                group = nivel_educativo,
                label = paste0(round(pob_porcentaje,1), "%")),
            position=position_dodge(width=0.9),
            vjust = -0.5,
            size = 3) +
  scale_fill_viridis_d() +
  labs(title = "Distribución porcentual de la población por sexo según el \n máximo nivel educativo. Total Aglomerados. Trimestre 4, año 2018",
       x = "Sexo",
       y = "Máximo nivel educativo alcanzado",
       caption = "Fuente: Elaboración propia en base a la EPH-INDEC")
```

<br>
<br>

* Posiciona de forma apilada cada una de las categorías, con límites de 0 a 1 (para comparación de proporciones). Agregamos etiquetas y estilo.
```{r echo=TRUE}
ggplot(data = base_graf2) +
  geom_bar(aes(x = sexo,
               y = pob_porcentaje,
               fill = nivel_educativo),
           position = "fill",
           stat = "identity") +
  geom_text(aes(x = sexo,
               y = pob_porcentaje,
               group = nivel_educativo,
               label = paste0(round(pob_porcentaje,1), "%")),
           position = "fill",
           vjust = 2.5,
           size = 5) +
  scale_fill_viridis_d() +
  labs(title = "Distribución porcentual de la población por sexo según el \n máximo nivel educativo. Total Aglomerados. Trimestre 4, año 2018",
       x = "Sexo",
       y = "Máximo nivel educativo alcanzado",
       caption = "Fuente: Elaboración propia en base a la EPH-INDEC")
```

```{r}
base_graf3 <- base_graf %>%
  calculate_tabulates("nivel_educativo", weights = "PONDERA") %>% 
  mutate(porcentaje = Freq / sum(Freq)*100) %>% 
  arrange(desc(porcentaje)) %>%
  mutate(ypos = cumsum(porcentaje) - 0.5 * porcentaje)

ggplot(base_graf3, 
       aes(x="", 
           y=porcentaje, 
           fill=nivel_educativo)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() + 
  geom_text(aes(y = ypos, label = round(porcentaje,1)), 
            color = "black", 
            size=5) +
  scale_fill_viridis_d()
```

<br>
<br>

### Hacer un gráfico de lineas, evolución en el tiempo.
